---
name: Integration Testing

on:
    deployment_status:
    push:
        branches:
            - JD_integration_tests

defaults:
    run:
        working-directory: ./integration

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest

        strategy:
            matrix:
                environment: [integration, staging]

        environment: ${{ matrix.environment }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: 3.9

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Set environment variables
              run: |
                touch .env
                echo "X_API_KEY=${{ secrets['${{ matrix.environment | upper }}\
                _X_API_KEY'] }}" >> .env

            - name: Run integration tests
              run: |
                pytest -m integration --maxfail=1 --disable-warnings --cov=integration
